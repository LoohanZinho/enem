<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Isolamento de Dados - ENEM Pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .user-data {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Isolamento de Dados</h1>
        <p>Este teste verifica se os dados de cada usu√°rio est√£o isolados corretamente.</p>
        
        <div class="test-section">
            <h3>1. Criar Usu√°rios de Teste</h3>
            <button onclick="createTestUsers()">Criar Usu√°rios</button>
            <div id="user-creation-result"></div>
        </div>

        <div class="test-section">
            <h3>2. Adicionar Dados para Usu√°rio 1</h3>
            <button onclick="addDataForUser1()">Adicionar Dados</button>
            <div id="user1-data-result"></div>
        </div>

        <div class="test-section">
            <h3>3. Verificar Dados do Usu√°rio 1</h3>
            <button onclick="checkUser1Data()">Verificar Dados</button>
            <div id="user1-check-result"></div>
        </div>

        <div class="test-section">
            <h3>4. Fazer Login como Usu√°rio 2</h3>
            <button onclick="loginAsUser2()">Login Usu√°rio 2</button>
            <div id="user2-login-result"></div>
        </div>

        <div class="test-section">
            <h3>5. Verificar Dados do Usu√°rio 2 (deve estar vazio)</h3>
            <button onclick="checkUser2Data()">Verificar Dados</button>
            <div id="user2-check-result"></div>
        </div>

        <div class="test-section">
            <h3>6. Adicionar Dados para Usu√°rio 2</h3>
            <button onclick="addDataForUser2()">Adicionar Dados</button>
            <div id="user2-data-result"></div>
        </div>

        <div class="test-section">
            <h3>7. Verificar Isolamento Final</h3>
            <button onclick="finalIsolationCheck()">Verificar Isolamento</button>
            <div id="final-check-result"></div>
        </div>

        <div class="test-section">
            <h3>8. Limpar Dados de Teste</h3>
            <button onclick="clearTestData()">Limpar Tudo</button>
            <div id="clear-result"></div>
        </div>
    </div>

    <script>
        // Simular o UserDataService
        class TestUserDataService {
            constructor() {
                this.STORAGE_PREFIX = 'enem_pro_user_data_';
                this.CURRENT_USER_KEY = 'enem_pro_current_user';
            }

            getCurrentUser() {
                const user = localStorage.getItem(this.CURRENT_USER_KEY);
                return user ? JSON.parse(user) : null;
            }

            getUserStorageKey() {
                const user = this.getCurrentUser();
                return user ? `${this.STORAGE_PREFIX}${user.id}` : null;
            }

            initializeUserData(user) {
                const userData = {
                    userId: user.id,
                    flashcards: [],
                    essays: [],
                    calendar: [],
                    notes: [],
                    goals: [],
                    moodEntries: [],
                    analytics: [],
                    gamification: [],
                    studySessions: [],
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                this.saveUserData(userData);
                return userData;
            }

            loadUserData() {
                const storageKey = this.getUserStorageKey();
                if (!storageKey) return null;

                try {
                    const data = localStorage.getItem(storageKey);
                    if (!data) return null;

                    const userData = JSON.parse(data);
                    return {
                        ...userData,
                        createdAt: new Date(userData.createdAt),
                        updatedAt: new Date(userData.updatedAt)
                    };
                } catch (error) {
                    console.error('Erro ao carregar dados do usu√°rio:', error);
                    return null;
                }
            }

            saveUserData(userData) {
                const storageKey = this.getUserStorageKey();
                if (!storageKey) return;

                try {
                    userData.updatedAt = new Date();
                    localStorage.setItem(storageKey, JSON.stringify(userData));
                } catch (error) {
                    console.error('Erro ao salvar dados do usu√°rio:', error);
                }
            }

            updateUserData(updates) {
                const currentData = this.loadUserData();
                if (!currentData) return;

                const updatedData = {
                    ...currentData,
                    ...updates,
                    updatedAt: new Date()
                };

                this.saveUserData(updatedData);
            }

            addFlashcard(flashcard) {
                const currentData = this.loadUserData();
                if (!currentData) return;

                const updatedFlashcards = [...currentData.flashcards, flashcard];
                this.updateUserData({ flashcards: updatedFlashcards });
            }

            addCalendarEvent(event) {
                const currentData = this.loadUserData();
                if (!currentData) return;

                const updatedCalendar = [...currentData.calendar, event];
                this.updateUserData({ calendar: updatedCalendar });
            }
        }

        const userDataService = new TestUserDataService();

        function createTestUsers() {
            try {
                // Usu√°rio 1
                const user1 = {
                    id: 'user1',
                    name: 'Jo√£o Silva',
                    email: 'joao@teste.com',
                    password: 'hash123',
                    phone: '11999999999',
                    cpf: '12345678901',
                    birthDate: '2000-01-01',
                    role: 'user',
                    createdAt: new Date().toISOString(),
                    isActive: true
                };

                // Usu√°rio 2
                const user2 = {
                    id: 'user2',
                    name: 'Maria Santos',
                    email: 'maria@teste.com',
                    password: 'hash456',
                    phone: '11888888888',
                    cpf: '98765432109',
                    birthDate: '2001-02-02',
                    role: 'user',
                    createdAt: new Date().toISOString(),
                    isActive: true
                };

                // Salvar usu√°rios
                localStorage.setItem('enem_pro_users', JSON.stringify([user1, user2]));

                document.getElementById('user-creation-result').innerHTML = 
                    '<div class="success">‚úÖ Usu√°rios criados com sucesso!</div>';

            } catch (error) {
                document.getElementById('user-creation-result').innerHTML = 
                    '<div class="error">‚ùå Erro ao criar usu√°rios: ' + error.message + '</div>';
            }
        }

        function addDataForUser1() {
            try {
                // Fazer login como usu√°rio 1
                const user1 = JSON.parse(localStorage.getItem('enem_pro_users'))[0];
                localStorage.setItem('enem_pro_current_user', JSON.stringify(user1));

                // Inicializar dados
                userDataService.initializeUserData(user1);

                // Adicionar dados de teste
                userDataService.addFlashcard({
                    id: 'card1',
                    front: 'Pergunta do Jo√£o',
                    back: 'Resposta do Jo√£o',
                    subject: 'Matem√°tica',
                    topic: '√Ålgebra',
                    difficulty: 'easy',
                    tags: ['teste'],
                    createdAt: new Date(),
                    reviewCount: 0,
                    correctCount: 0,
                    incorrectCount: 0,
                    easeFactor: 2.5,
                    interval: 1,
                    quality: 0,
                    isActive: true
                });

                userDataService.addCalendarEvent({
                    id: 'event1',
                    titulo: 'Estudo do Jo√£o',
                    descricao: 'Revis√£o de matem√°tica',
                    data: '2024-01-15',
                    hora: '14:00',
                    tipo: 'estudo',
                    materia: 'Matem√°tica',
                    duracao: 60,
                    concluido: false,
                    prioridade: 'alta'
                });

                document.getElementById('user1-data-result').innerHTML = 
                    '<div class="success">‚úÖ Dados adicionados para o Usu√°rio 1!</div>';

            } catch (error) {
                document.getElementById('user1-data-result').innerHTML = 
                    '<div class="error">‚ùå Erro ao adicionar dados: ' + error.message + '</div>';
            }
        }

        function checkUser1Data() {
            try {
                const userData = userDataService.loadUserData();
                if (userData) {
                    document.getElementById('user1-check-result').innerHTML = 
                        '<div class="success">‚úÖ Dados do Usu√°rio 1 carregados!</div>' +
                        '<div class="user-data">' + JSON.stringify(userData, null, 2) + '</div>';
                } else {
                    document.getElementById('user1-check-result').innerHTML = 
                        '<div class="error">‚ùå Nenhum dado encontrado para o Usu√°rio 1</div>';
                }
            } catch (error) {
                document.getElementById('user1-check-result').innerHTML = 
                    '<div class="error">‚ùå Erro ao verificar dados: ' + error.message + '</div>';
            }
        }

        function loginAsUser2() {
            try {
                const users = JSON.parse(localStorage.getItem('enem_pro_users'));
                const user2 = users[1];
                localStorage.setItem('enem_pro_current_user', JSON.stringify(user2));

                // Inicializar dados do usu√°rio 2
                userDataService.initializeUserData(user2);

                document.getElementById('user2-login-result').innerHTML = 
                    '<div class="success">‚úÖ Login como Usu√°rio 2 realizado!</div>';

            } catch (error) {
                document.getElementById('user2-login-result').innerHTML = 
                    '<div class="error">‚ùå Erro no login: ' + error.message + '</div>';
            }
        }

        function checkUser2Data() {
            try {
                const userData = userDataService.loadUserData();
                if (userData) {
                    const hasData = userData.flashcards.length > 0 || userData.calendar.length > 0;
                    if (hasData) {
                        document.getElementById('user2-check-result').innerHTML = 
                            '<div class="error">‚ùå ERRO: Usu√°rio 2 tem dados que n√£o deveria ter!</div>' +
                            '<div class="user-data">' + JSON.stringify(userData, null, 2) + '</div>';
                    } else {
                        document.getElementById('user2-check-result').innerHTML = 
                            '<div class="success">‚úÖ Usu√°rio 2 est√° vazio (correto)!</div>' +
                            '<div class="user-data">' + JSON.stringify(userData, null, 2) + '</div>';
                    }
                } else {
                    document.getElementById('user2-check-result').innerHTML = 
                        '<div class="error">‚ùå Nenhum dado encontrado para o Usu√°rio 2</div>';
                }
            } catch (error) {
                document.getElementById('user2-check-result').innerHTML = 
                    '<div class="error">‚ùå Erro ao verificar dados: ' + error.message + '</div>';
            }
        }

        function addDataForUser2() {
            try {
                // Adicionar dados para usu√°rio 2
                userDataService.addFlashcard({
                    id: 'card2',
                    front: 'Pergunta da Maria',
                    back: 'Resposta da Maria',
                    subject: 'Portugu√™s',
                    topic: 'Gram√°tica',
                    difficulty: 'medium',
                    tags: ['teste'],
                    createdAt: new Date(),
                    reviewCount: 0,
                    correctCount: 0,
                    incorrectCount: 0,
                    easeFactor: 2.5,
                    interval: 1,
                    quality: 0,
                    isActive: true
                });

                userDataService.addCalendarEvent({
                    id: 'event2',
                    titulo: 'Estudo da Maria',
                    descricao: 'Revis√£o de portugu√™s',
                    data: '2024-01-16',
                    hora: '15:00',
                    tipo: 'estudo',
                    materia: 'Portugu√™s',
                    duracao: 90,
                    concluido: false,
                    prioridade: 'media'
                });

                document.getElementById('user2-data-result').innerHTML = 
                    '<div class="success">‚úÖ Dados adicionados para o Usu√°rio 2!</div>';

            } catch (error) {
                document.getElementById('user2-data-result').innerHTML = 
                    '<div class="error">‚ùå Erro ao adicionar dados: ' + error.message + '</div>';
            }
        }

        function finalIsolationCheck() {
            try {
                // Verificar dados do usu√°rio 2
                const user2Data = userDataService.loadUserData();
                
                // Fazer login como usu√°rio 1
                const users = JSON.parse(localStorage.getItem('enem_pro_users'));
                const user1 = users[0];
                localStorage.setItem('enem_pro_current_user', JSON.stringify(user1));
                
                // Verificar dados do usu√°rio 1
                const user1Data = userDataService.loadUserData();

                let result = '<h4>Resultado do Teste de Isolamento:</h4>';
                
                // Verificar se os dados s√£o diferentes
                const user1HasData = user1Data && (user1Data.flashcards.length > 0 || user1Data.calendar.length > 0);
                const user2HasData = user2Data && (user2Data.flashcards.length > 0 || user2Data.calendar.length > 0);
                
                if (user1HasData && user2HasData) {
                    // Verificar se os dados s√£o realmente diferentes
                    const user1Card = user1Data.flashcards.find(c => c.id === 'card1');
                    const user2Card = user2Data.flashcards.find(c => c.id === 'card2');
                    
                    if (user1Card && user2Card && user1Card.front !== user2Card.front) {
                        result += '<div class="success">‚úÖ ISOLAMENTO FUNCIONANDO! Os dados dos usu√°rios est√£o separados corretamente.</div>';
                    } else {
                        result += '<div class="error">‚ùå ERRO: Os dados dos usu√°rios est√£o misturados!</div>';
                    }
                } else {
                    result += '<div class="error">‚ùå ERRO: Um dos usu√°rios n√£o tem dados!</div>';
                }

                result += '<h5>Dados do Usu√°rio 1:</h5>';
                result += '<div class="user-data">' + JSON.stringify(user1Data, null, 2) + '</div>';
                
                result += '<h5>Dados do Usu√°rio 2:</h5>';
                result += '<div class="user-data">' + JSON.stringify(user2Data, null, 2) + '</div>';

                document.getElementById('final-check-result').innerHTML = result;

            } catch (error) {
                document.getElementById('final-check-result').innerHTML = 
                    '<div class="error">‚ùå Erro no teste final: ' + error.message + '</div>';
            }
        }

        function clearTestData() {
            try {
                // Limpar todos os dados de teste
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('enem_pro_')) {
                        localStorage.removeItem(key);
                    }
                });

                document.getElementById('clear-result').innerHTML = 
                    '<div class="success">‚úÖ Todos os dados de teste foram limpos!</div>';

            } catch (error) {
                document.getElementById('clear-result').innerHTML = 
                    '<div class="error">‚ùå Erro ao limpar dados: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>

